PRAGMA foreign_keys = OFF;

CREATE TABLE sections_new (
    section_id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id INTEGER NOT NULL,
    term_id TEXT NOT NULL,
    campus_code TEXT NOT NULL,
    subject_code TEXT NOT NULL,
    section_number TEXT,
    index_number TEXT NOT NULL,
    open_status TEXT,
    is_open INTEGER DEFAULT 0,
    open_status_updated_at TEXT,
    instructors_text TEXT,
    section_notes TEXT,
    comments_json TEXT,
    eligibility_text TEXT,
    open_to_text TEXT,
    majors_json TEXT,
    minors_json TEXT,
    honor_programs_json TEXT,
    section_course_type TEXT,
    exam_code TEXT,
    exam_code_text TEXT,
    special_permission_add_code TEXT,
    special_permission_add_desc TEXT,
    special_permission_drop_code TEXT,
    special_permission_drop_desc TEXT,
    printed TEXT,
    session_print_indicator TEXT,
    subtitle TEXT,
    meeting_mode_summary TEXT,
    delivery_method TEXT,
    has_meetings INTEGER DEFAULT 0,
    source_hash TEXT,
    source_payload TEXT,
    created_at TEXT,
    updated_at TEXT,
    FOREIGN KEY (course_id) REFERENCES courses(course_id) ON DELETE CASCADE,
    FOREIGN KEY (term_id) REFERENCES terms(term_id),
    FOREIGN KEY (campus_code) REFERENCES campuses(campus_code),
    FOREIGN KEY (subject_code) REFERENCES subjects(subject_code)
);

INSERT INTO sections_new (
    section_id,
    course_id,
    term_id,
    campus_code,
    subject_code,
    section_number,
    index_number,
    open_status,
    is_open,
    open_status_updated_at,
    instructors_text,
    section_notes,
    comments_json,
    eligibility_text,
    open_to_text,
    majors_json,
    minors_json,
    honor_programs_json,
    section_course_type,
    exam_code,
    exam_code_text,
    special_permission_add_code,
    special_permission_add_desc,
    special_permission_drop_code,
    special_permission_drop_desc,
    printed,
    session_print_indicator,
    subtitle,
    meeting_mode_summary,
    delivery_method,
    has_meetings,
    source_hash,
    source_payload,
    created_at,
    updated_at
)
SELECT
    section_id,
    course_id,
    term_id,
    campus_code,
    subject_code,
    section_number,
    index_number,
    open_status,
    is_open,
    open_status_updated_at,
    instructors_text,
    section_notes,
    comments_json,
    eligibility_text,
    open_to_text,
    majors_json,
    minors_json,
    honor_programs_json,
    section_course_type,
    exam_code,
    exam_code_text,
    special_permission_add_code,
    special_permission_add_desc,
    special_permission_drop_code,
    special_permission_drop_desc,
    printed,
    session_print_indicator,
    subtitle,
    meeting_mode_summary,
    delivery_method,
    has_meetings,
    source_hash,
    source_payload,
    created_at,
    updated_at
FROM sections;

DROP TABLE sections;
ALTER TABLE sections_new RENAME TO sections;

CREATE UNIQUE INDEX IF NOT EXISTS idx_sections_term_index
    ON sections(term_id, index_number);

CREATE INDEX IF NOT EXISTS idx_sections_term_subject_status
    ON sections(term_id, campus_code, subject_code, is_open);

PRAGMA foreign_keys = ON;
