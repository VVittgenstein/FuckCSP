# ST-20251113-act-004-02-bot-sending (compact)

## 已落实事实
- 新增 Discord 发送模块 `notifications/discord/bot.ts`：加载配置验证（含 env 令牌），基于 token-bucket（全局 & per-channel）排队，支持 DM 打开失败回退频道、dry-run、override 钩子、mention 控制、雪花脱敏日志。
- 发送逻辑：POST `/channels/{id}/messages`，429/5xx 视为可重试，401/403/404 直接失败，提取 Retry-After/`retry_after` 回退，重试/backoff 来自配置；DM 通过 `POST /users/@me/channels` 创建并缓存 channel。
- CLI 验证脚本 `scripts/discord_send_test.ts`（脚本名 `npm run discord:test-send`）可指定 `--config --channel/--user --message [--dryRun --trace]` 触发一次发送并输出结果。
- 新增单测 `notifications/discord/tests/bot.test.ts`：用 stub fetch 覆盖默认频道发送、429 重试后成功、创建 DM 再发送的流转；`DISCORD_BOT_TOKEN` 由测试注入。
- `package.json` 增加 `discord:test-send` 脚本；record.json 将子任务标记为 done 并挂载上述工件；新增变更说明 `Compact/Compact-ST-20251113-act-004-02-bot-sending-2025-11-21-T110000Z.md`。

## 接口/行为变更
- 新增可复用发送入口 `notifications/discord/bot.ts`（`DiscordBot.send(request)` 返回带 attempts 的结果），配置解析入口 `loadDiscordBotConfig/resolveDiscordBotConfig`。
- 新 CLI 命令 `npm run discord:test-send -- ...` 暴露发送/干运行。

## 风险 / 未完成
- 本地未能运行 node --test（环境缺少 node 可执行）；需在具备 Node 的环境重跑单测。
- 未对真实 Discord API 做联调；真实令牌/频道需外部验证并关注速率/权限。
