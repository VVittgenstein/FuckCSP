# Compact – ST-20251113-act-010-02-polling-worker

## Implemented facts
- Added openSections polling worker (`workers/open_sections_poller.ts`) with CLI flags for term/campuses, interval/jitter, concurrency, SQLite path, timeout, subscription chunk size, metrics port, miss-threshold, and run-once mode. Uses existing SOC client and normalizer hash.
- Poll loop per campus with jittered cadence; performs fetch → snapshot write → section status updates → status events → open_event insert + subscription fan-out. Miss threshold prevents premature closes; empty payloads skip closures (soft outage handling). Closed sections also drop snapshots and reset `subscriptions.last_known_section_status`.
- Event storage added (`data/migrations/002_open_events.sql`, `data/schema.sql`): tables `open_events` (status_before/after, seat_delta, dedupe_key, payload, trace_id, snapshot_id FK) and `open_event_notifications` (per-subscription fan-out status, unique on event+subscription). Indexes for lookup/dedupe/status.
- Metrics endpoint (optional) exposes Prometheus text for polls, failures, events, notifications, last duration, and open index count per campus; accumulates totals.
- Subscription fan-out filters to pending/active subs, respects deliveryWindow/snooze/maxNotifications via preferences parsing (same default as API), dedupes by `open_event_notifications` unique constraint, and sets `subscriptions.last_known_section_status='OPEN'` on queue.
- Schema include updated to cover workers (`tsconfig.json`). Subtask status marked done in `record.json`; new migration artifact recorded.

## Interfaces / behavior changes
- New migration required: run after pulling to create `open_events` and `open_event_notifications`.
- New CLI entrypoint `workers/open_sections_poller.ts` (run via `tsx ...`); consumes existing SQLite schema and SOC endpoints; optional `/metrics` on provided port.
- Closing logic updates `subscriptions.last_known_section_status` for affected index; may affect downstream notification dedupe semantics.

## Risks / TODO / limits
- Typecheck currently fails in pre-existing files (`api/src/routes/subscriptions.ts` arity, `scripts/fetch_soc_data.ts` map typings); poller code compiles but repo not clean.
- No tests were added for the worker; runtime behavior unverified beyond structural code review.
- Fan-out currently only writes queue rows; actual senders/lock handling remain out of scope.

## Validation
- `npx tsc --noEmit` failed due to unrelated repo errors (see above); poller not fully validated via runtime test.
