# Compact – ST-20251113-act-010-03-resume-tests

## Implemented facts
- Poller now persists per-campus checkpoints (`--checkpoint`, default `scripts/poller_checkpoint.json`) capturing term/campus, last poll time, snapshot hash, open count, and miss counters; checkpoints are loaded on startup to restore miss debouncing and metrics, with warnings on corrupt files.
- `applySnapshot`/`createStatements`/checkpoint helpers exported; `main` is guarded to avoid auto-run when imported, enabling offline simulations.
- Poll outcome now returns `openCount/snapshotHash/polledAt/misses` and `pollOnce` writes checkpoints after each successful poll.
- Synthetic durability harness added (`scripts/poller_resume_sim.ts`): spins a temp SQLite with migrations + seeded section/subscription, runs 120 one-minute ticks with a restart after tick 81, replaying open→close→reopen; writes checkpoints each tick.
- Report `reports/poller_durability.md` documents scenario, results, checkpoint design, and runbook; record.json marks this subtask done with updated timestamp.

## Behavior / interface changes
- New CLI flag `--checkpoint <path>` for `workers/open_sections_poller.ts`; default file now created alongside runs. Startup log includes checkpoint path and restoration message per campus.
- Poll metrics’ `lastOpenCount` hydrates from checkpoints on boot; closure debounce survives restarts via restored miss counters.

## Self-test
- `npx tsx scripts/poller_resume_sim.ts` (offline): produced checkpoint `scripts/poller_checkpoint.json`; timeline shows open at t=30m, close at t=81m immediately after restart (restored miss), reopen at t=100m; totals opened=2, closed=1, events=3, notifications=2.

## Risks / TODO
- Checkpoint write failures are only logged; corrupt/missing files reset state (may delay closures by one debounce window). No live integration run against real SOC yet; production poller should be exercised with real DB/config.
